# KNN QQQ Trading Model — Progress Log

## Project Summary
KNN-based model trained exclusively on QQQ data to predict next-day direction.
Predictions are translated into TQQQ/SQQQ position recommendations for a $50K account.
Goal: consistent daily profit via EOD signal generation.

## Architecture
- **Training data**: QQQ + auxiliary (VIX, SPY, IWM, TLT, GLD) — NO TQQQ/SQQQ in training
- **Model**: KNN classifier with walk-forward validation
- **Output**: Daily JSON recommendation (buy TQQQ, buy SQQQ, or cash)
- **Position sizing**: Confidence-scaled, max 50% of account per trade

## Session Log

### Session 1 — Project Initialization (2026-02-14)
- **What was done:**
  - Created full project directory structure
  - Created feature_list.json with 28 features across 6 phases
  - Created claude-progress.txt (this file)
  - Created init.sh bootstrap script
  - Created README.md with project documentation
  - Created requirements.txt with all dependencies
  - Created .gitignore
  - Initialized git repository with initial commit
- **Current state:** Project scaffolding complete. No code written yet.
- **Next step:** Start Phase 1 — Feature F001 (Download QQQ data)
- **Blockers:** None
- **Features completed:** 0 / 28

### Session 2 — F001: Download QQQ Data (2026-02-14)
- **What was done:**
  - Created `data/download_qqq.py` — downloads QQQ daily OHLCV from 2011-01-01 via yfinance
  - Downloaded 3,802 rows (2011-01-03 to 2026-02-13) to `data/raw/qqq_daily.csv`
  - All 6 columns present: Open, High, Low, Close, Adj Close, Volume
  - Verified: no NaN values, no gaps > 3 business days
  - Marked F001 as passes: true in feature_list.json
- **Current state:** F001 complete. Raw QQQ data ready.
- **Next step:** F002 — Download auxiliary data (VIX, SPY, IWM, TLT, GLD)
- **Blockers:** None
- **Features completed:** 1 / 28

### Session 2b — F002: Download Auxiliary Data (2026-02-14)
- **What was done:**
  - Created `data/download_auxiliary.py` — downloads VIX, SPY, IWM, TLT, GLD
  - VIX: 6,821 rows from 1999-01-04
  - SPY: 6,821 rows from 1999-01-04
  - IWM: 6,468 rows from 2000-05-26
  - TLT: 5,925 rows from 2002-07-30
  - GLD: 5,343 rows from 2004-11-18
  - No NaN values in any dataset
  - Date alignment verified against QQQ (full overlap where dates exist)
  - Forward-fill logic included for up to 3 days if needed
- **Current state:** F001 + F002 complete. All raw data downloaded.
- **Next step:** F003 — Create merged master dataset
- **Blockers:** None — GLD starts late (2004) so master dataset will start from ~2004-11-18
- **Features completed:** 2 / 28

### Session 2c — F003: Merge Master Dataset (2026-02-14)
- **What was done:**
  - Created `data/merge_master.py` — inner-joins all 6 tickers on date
  - Master dataset: 5,343 rows, 36 columns, 2004-11-18 to 2026-02-13
  - QQQ columns unprefixed, auxiliary prefixed (VIX_, SPY_, IWM_, TLT_, GLD_)
  - Zero NaN values after inner join
  - Saved to `data/processed/master_daily.csv`
- **Current state:** F001-F003 complete. Clean master dataset ready.
- **Next step:** F004 — Compute target variable (next-day return + binary classification)
- **Blockers:** None
- **Features completed:** 3 / 28

### Session 2d — F004: Compute Target Variable (2026-02-15)
- **What was done:**
  - Created `data/compute_target.py` — computes next-day return and binary target
  - Added columns: daily_return, next_day_return, target (binary: 1=up, 0=down)
  - shift(-1) used correctly to avoid look-ahead bias
  - Class balance: 55.2% positive, 44.8% negative (slight bull bias)
  - Mean daily return: +0.061%, std: 1.36%
  - Final master dataset: 5,341 rows, 39 columns
- **Current state:** Phase 1 (Data Pipeline) COMPLETE. F001-F004 all pass.
- **Next step:** Phase 2, F005 — Price-based features
- **Blockers:** None
- **Features completed:** 4 / 28

### Session 2e — F005: Price-Based Features (2026-02-15)
- **What was done:**
  - Created `features/price_features.py` — 9 price-based features
  - Features: daily_return, 5/10/20d cumulative returns, dist from SMA 20/50/200, HL range %, close position
  - All use only data available at close on day T (no look-ahead)
  - NaN counts as expected from rolling windows (max 199 for SMA200)
  - Saved to `features/price_features.csv`
- **Current state:** F005 complete. Starting Phase 2 feature engineering.
- **Next step:** F006 — Momentum and oscillator features
- **Blockers:** None
- **Features completed:** 5 / 28

### Session 2f — F006-F009: Feature Engineering Batch (2026-02-15)
- **What was done:**
  - F006: 9 momentum features (RSI, MACD line/signal/hist, ROC 10/20, Stoch K/D, Williams %R)
  - F007: 8 volatility features (VIX close/changes, realized vol 10/20d, IV/RV ratio, BB position/width)
  - F008: 4 volume features (volume ratio, 5d trend, OBV ROC, vol-price divergence)
  - F009: 5 cross-asset features (QQQ/SPY RS, QQQ/IWM RS, TLT 5d ret, GLD 5d ret, SPY-QQQ spread)
  - Total: 26 features across 4 feature modules
- **Current state:** F005-F009 complete. Calendar features (F010) and merge (F011) remain in Phase 2.
- **Next step:** F010 — Calendar features, then F011 — Merge all features
- **Blockers:** None
- **Features completed:** 9 / 28

### Session 2g — F010-F011: Calendar Features + Feature Merge (2026-02-15)
- **What was done:**
  - F010: 4 calendar features (day of week, month, opex week, days since FOMC)
  - F011: Merged all 39 features into `data/processed/features_master.csv`
  - 5,142 clean rows (2005-09-06 to 2026-02-12), zero NaN
  - Generated correlation heatmap and feature registry JSON
  - Identified 12 highly correlated pairs (|r|>0.9) — expected, will be handled in feature selection
  - Target class balance: 55.3% positive
- **Current state:** Phase 2 (Feature Engineering) COMPLETE. All features computed and merged.
- **Next step:** Phase 3, F012 — Walk-forward train/test split infrastructure
- **Blockers:** None
- **Features completed:** 11 / 28

### Session 2h — F012-F013: Walk-Forward Splitter + Baseline KNN (2026-02-15)
- **What was done:**
  - F012: WalkForwardSplitter class with 9 unit tests (all pass)
  - F013: Baseline KNN classifier (K=10, distance-weighted, 5 features)
  - Walk-forward backtest 2020-2025: 54.9% accuracy, 0.63 Sharpe, 18.2% annual return
  - Max drawdown -56% (no confidence threshold yet)
  - Profit factor 1.15, precision 57.9%, recall 71.2%
- **Current state:** F012-F013 complete. Baseline model established.
- **Next step:** F014 — Hyperparameter tuning (K, distance metric, weighting)
- **Blockers:** None
- **Features completed:** 13 / 28

### Session 2i — F014: Hyperparameter Tuning (2026-02-15)
- **What was done:**
  - Grid search: 8 K values × 3 metrics × 2 weights = 48 combinations
  - Best config: K=7, manhattan distance, uniform weights
  - Best Sharpe: 0.646, accuracy 53.3%, annual return 18.7%
  - Saved tuning_results.csv and best_config.json
- **Current state:** F014 complete. Best hyperparams identified.
- **Next step:** F015 — Feature selection
- **Blockers:** None
- **Features completed:** 14 / 28

### Session 2j — F015-F017: Feature Selection, Window Opt, Calibration (2026-02-15)
- **What was done:**
  - F015: Forward feature selection — top 8 features (Sharpe 0.93) beat manual 5 (0.65) and all 39 (0.22)
    - Selected: macd_hist, close_position, return_5d, stoch_k, daily_return, rsi_14, stoch_d, williams_r
  - F016: Window optimization — 750 days best (Sharpe 1.51, 47.5% annual, -31% maxDD)
  - F017: Confidence calibration — threshold 0.58 optimal (Sharpe 1.54, trade 47% of days, -28% maxDD)
- **Current state:** Phase 3 (KNN Model Development) COMPLETE.
- **Best model config:** K=7, manhattan, uniform, window=750, 8 features, threshold=0.58
- **Next step:** Phase 4, F018 — Backtesting engine
- **Blockers:** None
- **Features completed:** 17 / 28

### Session 2k — F018-F021: Backtesting Engine (2026-02-15)
- **What was done:**
  - F018: Backtester class — $50K→$144.6K over 6 years, 34% long, 13% short, 53% cash
  - F019: Full metrics — 19.2% annual, 0.91 Sharpe, 1.30 Sortino, -28% maxDD, 56.3% win rate
  - F020: 6 plots (equity curve, monthly heatmap, drawdown, rolling Sharpe, signals, regime) + HTML report
  - F021: Stress tests — COVID: +17% vs QQQ -10%; 2022 bear: +17% vs QQQ -31.5%
- **Current state:** Phase 4 (Backtesting Engine) COMPLETE.
- **Next step:** Phase 5, F022 — Position sizing engine (TQQQ/SQQQ)
- **Blockers:** None
- **Features completed:** 21 / 28

### Session 2l — F022-F025: Position Sizing (TQQQ/SQQQ) (2026-02-15)
- **What was done:**
  - F022: PositionSizer class with linear/quadratic/step scaling
  - F023: Downloaded TQQQ/SQQQ data (4,027 rows each from 2010)
  - F024: Full TQQQ/SQQQ backtest — $50K→$90.3K, 10.4% annual, -18.5% maxDD
  - F025: Sizing optimization (75 combos) — best: threshold 0.55, 33% max, step scaling
    - Sharpe 0.83, 13.5% annual, -19.2% maxDD (within 25% constraint)
- **Current state:** Phase 5 (Position Sizing) COMPLETE.
- **Optimal sizing:** bull_threshold=0.55, max_position=33%, step scaling
- **Next step:** Phase 6, F026 — Daily signal generation script
- **Blockers:** None
- **Features completed:** 25 / 28

### Session 2m — F026-F028: Daily Signal Generator (2026-02-15)
- **What was done:**
  - F026: `signals/generate_daily_signal.py` — full pipeline: download → features → predict → size → recommend
    - Tested: predicts QQQ UP (57.1%), recommends BUY 85 TQQQ shares ($4,125, 8.2% of account)
  - F027: `scripts/retrain_model.py` — daily retraining pipeline, saves timestamped model artifacts
  - F028: `signals/trade_journal.py` — trade journal with signal logging, result updates, weekly summary
- **Current state:** ALL 28 FEATURES COMPLETE. Project fully implemented.
- **Final model:** K=7, manhattan, uniform, 750-day window, 8 features, 0.55 bull threshold
- **Backtest results (2020-2025):** 19.2% annual, 0.91 Sharpe, -28% maxDD on QQQ; TQQQ/SQQQ: 13.5% annual, 0.83 Sharpe, -19.2% maxDD
- **Next step:** Project complete — run `python3 signals/generate_daily_signal.py` daily at EOD
- **Blockers:** None
- **Features completed:** 28 / 28

### Session 3 — Spec Update: Discrete Leverage + Vol Targeting (2026-02-16)
- **What was done:**
  - Extended data window back to 2006 (from 2011), re-ran full pipeline
  - Re-ran feature selection, window optimization, calibration on extended data
  - **Rewrote `signals/position_sizer.py`**: replaced tiered 10/20/30% allocation with 7 discrete leverage levels (+300% to -300%) via TQQQ/SQQQ + cash
  - Added volatility targeting: caps leverage when realized vol × leverage > 2× QQQ vol target
  - **Rewrote `backtesting/tqqq_sqqq_backtest.py`**: passes realized vol, tracks leverage state, reports leverage distribution
  - **Updated `signals/generate_daily_signal.py`**: uses new PositionSizer API with vol targeting, no longer depends on sizing_config thresholds
  - **Updated `signals/optimize_sizing.py`**: grid searches over threshold sets (wide/narrow/aggressive/conservative) × vol target multiples
  - **Updated `signals/sizing_config.json`**: documents new leverage system
  - All 9 tests pass
- **Current state:** Discrete leverage system fully integrated across position sizer, backtest, daily signal, and optimizer.
- **Next step:** Run full TQQQ/SQQQ backtest to validate new leverage system performance
- **Blockers:** None
- **Features completed:** 28 / 28

### Session 3b — Backtest Analysis & Drawdown Deep Dive (2026-02-16)
- **What was done:**
  - Verified no data leakage: 0 violations across 1,508 splits, target/features verified at sample points
  - Ran full TQQQ/SQQQ backtest: $50K → $559K, 49.2% annual, 1.16 Sharpe, -51% max DD
  - Tested 36 dead zone × vol target combos to reduce drawdown
  - **Best config: 10pt dead zone + 1.0x vol target** → Sharpe 1.18, 34% annual, -31.4% max DD
  - Deep analysis of drawdown period (Nov 2021 - Jul 2022):
    - Model has structural bullish bias: LONG 62% of days even during bear market
    - Long accuracy drops to 45.8% during bear (vs 65% in bull)
    - Root cause: mean-reverting features (RSI, MACD, stochastics) + historical 55% up base rate
    - Short trades actually work (52% WR, +$36K) — model just doesn't go short enough
  - Created BACKTEST_FINDINGS.md with full analysis
  - Updated README with current results and known limitations
- **Current state:** Model works well in bull/neutral regimes, underperforms in sustained bear markets due to bullish bias.
- **Next step:** Address bullish bias — regime detection, trend-following features, asymmetric thresholds
- **Blockers:** None
- **Features completed:** 28 / 28

### Session 3c — Regime Features & Trend Overlay Experiments (2026-02-16)
- **What was done:**
  - Created 4 regime features: above_sma200 (binary), golden_cross (binary), ADX(14), days_below_sma200
  - Added regime_features.py, updated merge pipeline and daily signal generator
  - **Regime features as KNN inputs: FAILED.** Curse of dimensionality — adding binary/categorical regime features to 8 continuous oscillators fractured the neighbor search. All combos produced negative Sharpe. Forward selection also rejected all 4 regime features.
  - **Regime overlay (4 modes): marginal benefit.** Tested light/moderate/aggressive/symmetric overlays that cap leverage based on trend state. With 1.0x vol targeting, overlays are redundant (vol target already caps at +/-100%). With 2.0x, overlays hurt bear P&L by also capping correct bounce calls.
  - **Key finding: 1.0x vol targeting is the optimal solution.** It reduces leverage proportionally via volatility rather than binary regime rules. Sharpe 1.18, -31.4% max DD, profitable in ALL regimes.
  - Applied 1.0x vol target as production default across position_sizer, backtest, daily signal
  - Production backtest: $50K → $291K, 34% annual, 1.18 Sharpe, -31.4% max DD
- **Current state:** Production config finalized. 1.0x vol targeting. Regime overlay available but not active.
- **Next step:** TBD — discuss further improvements
- **Blockers:** None
- **Features completed:** 28 / 28

### Session 3d — New Feature Experiments (2026-02-16)
- **What was done:**
  - **Overnight gap + intraday return features:** Added to price_features.py
    - Overnight gap alone: Sharpe dropped from 1.51→0.52, but bear accuracy +3.9%
    - Both gap + intraday: Sharpe 0.91, max DD improved (-23.5%), bear accuracy +3.9%
    - **Verdict: not added to baseline** — no combination beat baseline Sharpe
  - **VIX term structure features:** Downloaded VIX3M data (4,927 rows from 2006), created feat_vix_term_structure (VIX/VIX3M ratio) and feat_vix_ts_change_5d
    - +vix_term_structure: Sharpe 0.60 (down from 1.51), worse across all metrics
    - +ts_change_5d: Sharpe 0.26, worse everything
    - Swapping stoch_d or stoch_k for TS: still worse (Sharpe 0.35-0.67)
    - **Verdict: not added** — VIX term structure hurts model performance
  - **Key insight:** KNN's 8 momentum/oscillator features are tightly co-optimized. Adding fundamentally different feature types (term structure, overnight gaps, regime indicators) degrades neighbor search. The model's feature space is at its sweet spot.
  - Reverted pipeline to original (no VIX3M in master merge), kept features available but not in default config
  - Downloaded 1-hour intraday data for QQQ/TQQQ/SQQQ (2 years: Feb 2024 - Feb 2026) for future stop-loss work
- **Current state:** Baseline 8 features confirmed optimal. New features tested and rejected.
- **Next step:** Discuss intraday stop-loss implementation using hourly data
- **Blockers:** None
- **Features completed:** 28 / 28

### Session 3e — Professional Stop Loss Analysis (2026-02-17)
- **What was done:**
  - Analyzed professional stop loss levels: prev day low/high, 2-day low/high, pivot S1/R1
  - QQQ breaches prev day low 41.6% of days, prev day high 55.8%
  - Integrated stop loss infrastructure into `backtesting/tqqq_sqqq_backtest.py`:
    - `_compute_stop_levels()`: computes structural stop levels (two_day, prev_day, pivot)
    - `_estimate_stop_exit_price()`: estimates leveraged ETF exit price with gap-down detection
    - `run_tqqq_sqqq_backtest()`: now accepts optional `stop_type` and `qqq` parameters
  - **Validated stop exit estimates against hourly data (2024-2025):**
    - Proportional estimate was 0.8% too optimistic on average
    - 69% of stops trigger at the opening bar (overnight gaps, not intraday)
    - 53% of stopped trades would have recovered by close
    - Fixed estimates: gap-down → exit at leveraged ETF open; intraday → proportional + 0.5% slippage
  - **Full 2020-2025 backtest with corrected stops (all with 1.0x vol targeting):**
    - Baseline (no stops): Sharpe 1.18, 34% annual, -31.4% maxDD
    - 2-Day Low/High: Sharpe 0.80, 21% annual, -28.8% maxDD
    - Prev Day Low/High: Sharpe 0.64, 16% annual, -26.8% maxDD
    - Pivot S1/R1: Sharpe 0.72, 19% annual, -27.1% maxDD
  - **Tested selective stops:** longs-only, low-confidence only — all reduced Sharpe
  - **Key finding: stops don't improve this strategy.** Vol targeting (1.0x) is fundamentally better because:
    1. It's preventive (reduces position size BEFORE bad days) vs reactive (exits AFTER damage starts)
    2. 69% of stops trigger at open (gap downs) — damage already done before stop can help
    3. 53% of stopped trades recover — stops cut winning mean-reversion trades
    4. Vol targeting preserves Sharpe (1.18) while halving max DD; stops destroy Sharpe
  - Stop loss infrastructure kept in codebase (available via `stop_type` parameter) but not used in production
- **Current state:** Stop loss analysis complete. Vol targeting confirmed as optimal risk management.
- **Next step:** TBD — discuss further improvements with user
- **Blockers:** None
- **Features completed:** 28 / 28
